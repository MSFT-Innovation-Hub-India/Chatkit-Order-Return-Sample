<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatKit Todo - Your AI-Powered Todo List</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    
    <!-- Branding CSS - customize this file for your brand -->
    <link rel="stylesheet" href="/static/branding.css">
    
    <style>
        /* Map branding variables to component variables */
        :root {
            --primary-color: var(--brand-primary, #0078d4);
            --primary-hover: var(--brand-primary-hover, #106ebe);
            --success-color: var(--color-success, #28a745);
            --warning-color: var(--color-warning, #ffc107);
            --danger-color: var(--color-danger, #dc3545);
            --secondary-color: var(--color-secondary, #6c757d);
            --background-color: var(--background-page, #f5f5f5);
            --surface-color: var(--background-surface, #ffffff);
            --text-color: var(--text-primary, #333333);
            --text-secondary: var(--text-secondary, #666666);
            --border-color: var(--border-color, #e0e0e0);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--background-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--header-gradient-start, var(--primary-color)), var(--header-gradient-end, #005a9e));
            color: var(--text-on-primary, white);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .header-logo { 
            font-size: 28px; 
        }
        .header-logo img {
            width: var(--logo-width, 32px);
            height: var(--logo-height, 32px);
            border-radius: var(--logo-border-radius, 6px);
            object-fit: contain;
        }
        .header-logo-emoji {
            font-size: 28px;
        }
        .header-title { font-size: 20px; font-weight: 600; }
        .header-subtitle { font-size: 14px; opacity: 0.9; margin-left: auto; }
        
        .new-chat-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .new-chat-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Main content area */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--surface-color);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
        }
        
        .sidebar h2 {
            color: var(--primary-color);
            font-size: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar ul {
            list-style: none;
            margin-bottom: 20px;
        }
        
        .sidebar li {
            padding: 6px 0;
            color: var(--text-color);
            font-size: 13px;
        }
        
        .example-prompts {
            background: linear-gradient(135deg, #f0f7ff, #e8f4ff);
            border-radius: 12px;
            padding: 16px;
        }
        
        .prompt-chip {
            display: inline-block;
            background: var(--surface-color);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            margin: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .prompt-chip:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 120, 212, 0.3);
        }
        
        /* Chat container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--surface-color);
        }
        
        /* Messages area */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .message {
            margin-bottom: 16px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            margin-left: auto;
        }
        
        .message-content {
            padding: 12px 16px;
            border-radius: 16px;
            line-height: 1.5;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-color), #005a9e);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.assistant .message-content {
            background: #f0f0f0;
            color: var(--text-color);
            border-bottom-left-radius: 4px;
        }
        
        .message-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }
        
        .message.user .message-label { text-align: right; }
        
        /* Welcome message */
        .welcome {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .welcome h2 {
            font-size: 28px;
            margin-bottom: 12px;
            color: var(--text-color);
        }
        
        .welcome p { 
            font-size: 16px; 
            color: var(--text-secondary);
        }
        
        /* Widget Styles */
        .widget-container {
            margin: 16px 0;
            max-width: 100%;
        }
        
        .widget-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .widget-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }
        
        .widget-title.medium { font-size: 18px; }
        .widget-title.small { font-size: 16px; }
        
        .widget-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
        }
        
        .widget-spacer {
            flex: 1;
        }
        
        .widget-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .widget-badge.success { background: #d4edda; color: #155724; }
        .widget-badge.warning { background: #fff3cd; color: #856404; }
        .widget-badge.danger { background: #f8d7da; color: #721c24; }
        .widget-badge.primary { background: #cce5ff; color: #004085; }
        
        .widget-divider {
            height: 1px;
            background: var(--border-color);
            margin: 12px 0;
        }
        
        .widget-form {
            margin: 8px 0;
        }
        
        .widget-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .widget-input:focus {
            border-color: var(--primary-color);
        }
        
        .widget-input::placeholder {
            color: #999;
        }
        
        .widget-button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .widget-button.primary {
            background: var(--primary-color);
            color: white;
        }
        
        .widget-button.primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 120, 212, 0.3);
        }
        
        .widget-button.success {
            background: var(--success-color);
            color: white;
        }
        
        .widget-button.success:hover {
            background: #218838;
        }
        
        .widget-button.secondary {
            background: var(--secondary-color);
            color: white;
        }
        
        .widget-button.danger {
            background: transparent;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }
        
        .widget-button.danger:hover {
            background: var(--danger-color);
            color: white;
        }
        
        .widget-button.small {
            padding: 6px 12px;
            font-size: 13px;
        }
        
        .widget-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--primary-color);
            cursor: pointer;
        }
        
        .widget-text {
            font-size: 14px;
            color: var(--text-color);
        }
        
        .widget-text.strikethrough {
            text-decoration: line-through;
            color: var(--text-secondary);
        }
        
        .widget-text.center {
            text-align: center;
            width: 100%;
        }
        
        .widget-box {
            padding: 20px;
            text-align: center;
        }
        
        .todo-item {
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .todo-item:last-child {
            border-bottom: none;
        }
        
        /* Input area */
        .input-area {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            background: var(--surface-color);
        }
        
        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-wrapper textarea {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 24px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            outline: none;
            min-height: 48px;
            max-height: 120px;
            transition: border-color 0.2s;
        }
        
        .input-wrapper textarea:focus {
            border-color: var(--primary-color);
        }
        
        .send-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-button:hover:not(:disabled) {
            background: var(--primary-hover);
            transform: scale(1.05);
        }
        
        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 4px 0;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #888;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }
        
        /* Scrollbar */
        .messages::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .messages::-webkit-scrollbar-track,
        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .messages::-webkit-scrollbar-thumb,
        .sidebar::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <header class="header">
        <span class="header-logo" id="header-logo">
            <span class="header-logo-emoji">‚úÖ</span>
        </span>
        <span class="header-title" id="header-title">ChatKit Todo</span>
        <button class="new-chat-btn" onclick="startNewChat()" title="Start a new conversation">üîÑ New Chat</button>
        <span class="header-subtitle" id="header-subtitle">Powered by Azure OpenAI + ChatKit Widgets</span>
    </header>
    
    <div class="main-content">
        <aside class="sidebar">
            <h2>üìñ How to Use</h2>
            <ul>
                <li>üí¨ Ask me to add tasks to your todo list</li>
                <li>üìã Say "show my todos" to see the interactive widget</li>
                <li>‚úÖ Click checkboxes or buttons to manage tasks</li>
                <li>üóëÔ∏è Delete tasks you no longer need</li>
            </ul>
            
            <h2>üí° Try These Prompts</h2>
            <div class="example-prompts">
                <span class="prompt-chip" onclick="sendPrompt('Show me my todos')">üìã Show my todos</span>
                <span class="prompt-chip" onclick="sendPrompt('Add buy groceries')">üõí Add buy groceries</span>
                <span class="prompt-chip" onclick="sendPrompt('Add three tasks: call mom, finish report, and exercise')">üìù Add multiple tasks</span>
                <span class="prompt-chip" onclick="sendPrompt('What can you do?')">‚ùì What can you do?</span>
            </div>
            
            <h2 style="margin-top: 20px;">‚ú® Features</h2>
            <ul>
                <li>üé® Interactive widget UI</li>
                <li>üìù Form inputs for adding todos</li>
                <li>‚òëÔ∏è Checkbox to toggle completion</li>
                <li>üîò Action buttons (complete, delete)</li>
                <li>üíæ Persistent storage</li>
                <li>‚òÅÔ∏è Azure OpenAI powered</li>
            </ul>
        </aside>
        
        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="welcome">
                    <h2>üëã Welcome to ChatKit Todo!</h2>
                    <p>I'm your AI-powered todo assistant with interactive widgets.<br>
                    Ask me to show your todos to see the magic! ‚ú®</p>
                </div>
            </div>
            
            <div class="input-area">
                <div class="input-wrapper">
                    <textarea 
                        id="message-input" 
                        placeholder="Try: 'Show me my todos' to see interactive widgets..."
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                    <button class="send-button" id="send-button" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Persist thread ID in localStorage so todos survive page refresh
        let threadId = localStorage.getItem('chatkit_thread_id');
        if (!threadId) {
            threadId = 'thread_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('chatkit_thread_id', threadId);
        }
        console.log('Using thread ID:', threadId);
        
        let isProcessing = false;
        let currentWidgetContainer = null;
        
        // Start a new chat session with a fresh thread ID
        function startNewChat() {
            threadId = 'thread_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('chatkit_thread_id', threadId);
            console.log('Started new chat with thread ID:', threadId);
            
            // Clear the messages container and show welcome message
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = `
                <div class="welcome">
                    <h2>üëã Welcome to ChatKit Todo!</h2>
                    <p>I'm your AI-powered todo assistant with interactive widgets.<br>
                    Ask me to show your todos to see the magic! ‚ú®</p>
                </div>
            `;
            currentWidgetContainer = null;
        }
        
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        
        // Load branding configuration from server
        async function loadBranding() {
            try {
                const response = await fetch('/api/branding');
                if (response.ok) {
                    const branding = await response.json();
                    
                    // Update page title
                    document.title = `${branding.name} - ${branding.tagline}`;
                    
                    // Update header title
                    document.getElementById('header-title').textContent = branding.name;
                    document.getElementById('header-subtitle').textContent = branding.tagline;
                    
                    // Update logo if provided
                    if (branding.logoUrl && branding.logoUrl !== '/static/logo.png') {
                        const logoContainer = document.getElementById('header-logo');
                        logoContainer.innerHTML = `<img src="${branding.logoUrl}" alt="${branding.name} logo" onerror="this.parentElement.innerHTML='<span class=\\'header-logo-emoji\\'>‚úÖ</span>'">`;
                    }
                    
                    // Update primary color dynamically
                    if (branding.primaryColor) {
                        document.documentElement.style.setProperty('--brand-primary', branding.primaryColor);
                        document.documentElement.style.setProperty('--header-gradient-start', branding.primaryColor);
                    }
                    
                    // Update favicon
                    if (branding.faviconUrl) {
                        const favicon = document.querySelector('link[rel="icon"]');
                        if (favicon) favicon.href = branding.faviconUrl;
                    }
                }
            } catch (error) {
                console.log('Using default branding');
            }
        }
        
        // Load branding on page load
        loadBranding();
        
        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function addMessage(content, role) {
            // Remove welcome message on first message
            const welcome = messagesContainer.querySelector('.welcome');
            if (welcome) welcome.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `
                <div class="message-label">${role === 'user' ? 'You' : 'Assistant'}</div>
                <div class="message-content">${formatMessage(content)}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return messageDiv;
        }
        
        function formatMessage(content) {
            return content
                .replace(/\n/g, '<br>')
                .replace(/‚¨ú/g, '<span style="color: #666;">‚¨ú</span>')
                .replace(/‚úÖ/g, '<span style="color: #28a745;">‚úÖ</span>');
        }
        
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="message-label">Assistant</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }
        
        // Render ChatKit widget from server data
        function renderWidget(widgetData) {
            console.log('Rendering widget:', widgetData);
            console.log('Widget type:', widgetData?.type);
            console.log('Widget children:', widgetData?.children);
            
            const container = document.createElement('div');
            container.className = 'widget-container';
            container.id = `widget_${widgetData.id || Date.now()}`;
            
            const card = document.createElement('div');
            card.className = 'widget-card';
            
            if (widgetData.children && Array.isArray(widgetData.children)) {
                console.log('Processing', widgetData.children.length, 'children');
                for (const child of widgetData.children) {
                    console.log('Rendering child:', child.type, child.id);
                    const element = renderWidgetComponent(child);
                    if (element) {
                        console.log('Appended element for:', child.type);
                        card.appendChild(element);
                    } else {
                        console.log('No element returned for:', child.type);
                    }
                }
            } else {
                console.log('No children found in widget data');
            }
            
            container.appendChild(card);
            console.log('Card content:', card.innerHTML.substring(0, 500));
            
            // Replace existing widget or append new one
            if (currentWidgetContainer) {
                currentWidgetContainer.replaceWith(container);
            } else {
                messagesContainer.appendChild(container);
            }
            currentWidgetContainer = container;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function renderWidgetComponent(component) {
            if (!component || !component.type) return null;
            
            const type = component.type.toLowerCase();
            
            switch (type) {
                case 'title':
                    const title = document.createElement('h3');
                    title.className = `widget-title ${component.size || ''}`;
                    title.textContent = component.value || '';
                    return title;
                    
                case 'text':
                    const text = document.createElement('span');
                    text.className = 'widget-text';
                    if (component.strikethrough) text.classList.add('strikethrough');
                    if (component.align === 'center') text.classList.add('center');
                    text.textContent = component.value || '';
                    return text;
                    
                case 'row':
                    const row = document.createElement('div');
                    row.className = 'widget-row';
                    if (component.id && component.id.startsWith('todo_')) {
                        row.classList.add('todo-item');
                    }
                    if (component.children) {
                        for (const child of component.children) {
                            const el = renderWidgetComponent(child);
                            if (el) row.appendChild(el);
                        }
                    }
                    return row;
                    
                case 'spacer':
                    const spacer = document.createElement('div');
                    spacer.className = 'widget-spacer';
                    return spacer;
                    
                case 'badge':
                    const badge = document.createElement('span');
                    badge.className = `widget-badge ${component.color || 'primary'}`;
                    badge.textContent = component.label || component.value || '';
                    return badge;
                    
                case 'divider':
                    const divider = document.createElement('div');
                    divider.className = 'widget-divider';
                    return divider;
                    
                case 'form':
                    const form = document.createElement('form');
                    form.className = 'widget-form';
                    form.onsubmit = (e) => e.preventDefault();
                    if (component.children) {
                        for (const child of component.children) {
                            const el = renderWidgetComponent(child);
                            if (el) form.appendChild(el);
                        }
                    }
                    return form;
                    
                case 'input':
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'widget-input';
                    input.placeholder = component.placeholder || '';
                    input.name = component.name || component.id;
                    input.id = `input_${component.id}`;
                    return input;
                    
                case 'button':
                    const button = document.createElement('button');
                    button.className = `widget-button ${component.color || component.variant || 'primary'} ${component.size || ''}`;
                    button.textContent = component.label || '';
                    if (component.disabled) button.disabled = true;
                    if (component.onClickAction || component.action) {
                        const action = component.onClickAction || component.action;
                        button.onclick = () => handleWidgetAction(action, component.id);
                    }
                    return button;
                    
                case 'checkbox':
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'widget-checkbox';
                    checkbox.checked = component.defaultChecked || component.checked || false;
                    if (component.onChangeAction || component.action) {
                        const action = component.onChangeAction || component.action;
                        checkbox.onchange = () => handleWidgetAction(action, component.id);
                    }
                    return checkbox;
                    
                case 'box':
                    const box = document.createElement('div');
                    box.className = 'widget-box';
                    if (component.children) {
                        for (const child of component.children) {
                            const el = renderWidgetComponent(child);
                            if (el) box.appendChild(el);
                        }
                    }
                    return box;
                    
                default:
                    console.log('Unknown widget type:', component.type);
                    return null;
            }
        }
        
        async function handleWidgetAction(action, componentId) {
            if (!action || !action.type) {
                console.log('Invalid action:', action);
                return;
            }
            
            // Build the action payload for the server
            const actionPayload = { ...(action.payload || {}) };
            
            // Collect form data if this is a form submission
            if (action.type === 'add_todo_form') {
                const input = document.querySelector('.widget-input');
                if (input) {
                    actionPayload.todo_text = input.value;
                    input.value = '';
                }
            }
            
            console.log('Widget action:', action.type, actionPayload);
            
            try {
                const response = await fetch('/chatkit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'threads.custom_action',
                        params: {
                            thread_id: threadId,
                            item_id: null,
                            action: {
                                type: action.type,
                                payload: actionPayload
                            }
                        }
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                // Handle streaming response for widget updates
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                console.log('Action response:', data.type, data);
                                
                                if (data.type === 'thread.item.added' && data.item) {
                                    console.log('Item added - type:', data.item.type);
                                    // Check if it's a widget
                                    if (data.item.type === 'widget' && data.item.widget) {
                                        console.log('Rendering widget from item.added');
                                        renderWidget(data.item.widget);
                                    }
                                } else if (data.type === 'thread.item.done' && data.item) {
                                    console.log('Item done - type:', data.item.type);
                                    if (data.item.type === 'widget' && data.item.widget) {
                                        console.log('Rendering widget from item.done');
                                        renderWidget(data.item.widget);
                                    }
                                }
                            } catch (e) {
                                console.log('Parse error:', e, 'line:', line);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Widget action error:', error);
            }
        }
        
        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || isProcessing) return;
            
            isProcessing = true;
            sendButton.disabled = true;
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            addMessage(content, 'user');
            addTypingIndicator();
            
            try {
                const response = await fetch('/chatkit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'threads.add_user_message',
                        params: {
                            thread_id: threadId,
                            input: {
                                content: [{ type: 'input_text', text: content }],
                                attachments: [],
                                inference_options: {}
                            }
                        }
                    })
                });
                
                removeTypingIndicator();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantMessage = '';
                let messageDiv = null;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                console.log('SSE Event:', data.type, data);
                                
                                // Handle text message streaming
                                if (data.type === 'thread.item.updated') {
                                    const update = data.update;
                                    if (update && update.type === 'assistant_message.content_part.text_delta') {
                                        const deltaText = update.delta;
                                        if (deltaText) {
                                            assistantMessage += deltaText;
                                            if (!messageDiv) {
                                                messageDiv = addMessage(assistantMessage, 'assistant');
                                            } else {
                                                messageDiv.querySelector('.message-content').innerHTML = formatMessage(assistantMessage);
                                            }
                                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                        }
                                    } else if (update && update.type === 'assistant_message.content_part.added') {
                                        if (!messageDiv) {
                                            messageDiv = addMessage('', 'assistant');
                                        }
                                    }
                                } else if (data.type === 'thread.item.added') {
                                    const item = data.item;
                                    // Handle widget items
                                    if (item && item.type === 'widget' && item.widget) {
                                        renderWidget(item.widget);
                                    } else if (item && item.type === 'assistant_message') {
                                        if (!messageDiv) {
                                            messageDiv = addMessage('', 'assistant');
                                        }
                                        if (item.content) {
                                            let fullText = '';
                                            for (const part of item.content) {
                                                if (part.type === 'text' && part.text) {
                                                    fullText += part.text;
                                                }
                                            }
                                            if (fullText) {
                                                assistantMessage = fullText;
                                                messageDiv.querySelector('.message-content').innerHTML = formatMessage(fullText);
                                            }
                                        }
                                    }
                                } else if (data.type === 'thread.item.done') {
                                    const item = data.item;
                                    // Handle widget completion
                                    if (item && item.type === 'widget' && item.widget) {
                                        renderWidget(item.widget);
                                    } else if (item && item.content) {
                                        let fullText = '';
                                        for (const part of item.content) {
                                            if (part.type === 'text' && part.text) {
                                                fullText += part.text;
                                            }
                                        }
                                        if (fullText && !messageDiv) {
                                            messageDiv = addMessage(fullText, 'assistant');
                                        } else if (fullText && messageDiv) {
                                            messageDiv.querySelector('.message-content').innerHTML = formatMessage(fullText);
                                        }
                                    }
                                } else if (data.type === 'thread.created') {
                                    threadId = data.thread.id;
                                }
                            } catch (e) {
                                // Skip malformed JSON
                            }
                        }
                    }
                }
                
                if (!messageDiv && assistantMessage) {
                    addMessage(assistantMessage, 'assistant');
                }
                
            } catch (error) {
                removeTypingIndicator();
                console.error('Error:', error);
                addMessage('Sorry, something went wrong. Please try again.', 'assistant');
            } finally {
                isProcessing = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        }
        
        function sendPrompt(prompt) {
            messageInput.value = prompt;
            sendMessage();
        }
        
        // Focus input on load
        messageInput.focus();
    </script>
</body>
</html>
